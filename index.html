<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>売上一覧PDF → CSV変換ツール（座標解析・税率別対応）</title>

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; background:#f4f6f8; color:#333; padding:20px; }
    .container { max-width: 1100px; margin:0 auto; background:#fff; padding:24px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
    h1 { color:#1565c0; font-size:1.35rem; text-align:center; border-bottom:2px solid #e3f2fd; padding-bottom:12px; margin:0 0 18px; }
    .upload-area { border:2px dashed #90caf9; background:#f3e5f5; padding:22px; text-align:center; border-radius:10px; margin-bottom:14px; }
    .upload-area input[type="file"] { font-size:1rem; cursor:pointer; }
    .setting-area { display:flex; gap:14px; background:#fff8e1; padding:12px; border-radius:10px; border:1px solid #ffe0b2; align-items:center; flex-wrap:wrap; }
    .setting-area label { font-weight:700; font-size:0.9rem; }
    .setting-area input[type="date"] { padding:8px; border-radius:6px; border:1px solid #ccc; font-size:1rem; }
    .hint { font-size:0.82rem; color:#666; }

    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border:1px solid #e0e0e0; padding:8px; text-align:center; font-size:0.9rem; }
    th { background:#f8f9fa; color:#444; }
    td input { width:92%; padding:6px; text-align:right; border:1px solid #cfd8dc; border-radius:6px; }

    .btn { display:block; width:100%; padding:14px; border:none; border-radius:10px; font-size:1.08rem; font-weight:800; cursor:pointer; margin-top:14px; transition:0.15s; }
    .btn:hover { opacity:0.9; }
    .btn-csv { background:#2e7d32; color:#fff; }
    .btn-json { background:#455a64; color:#fff; }

    #status { text-align:center; font-weight:700; color:#d32f2f; margin:10px 0 0; white-space:pre-wrap; }
    #debug { display:none; background:#0b1020; color:#e8eaf6; padding:12px; border-radius:10px; margin-top:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap; }
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .toggle { display:flex; gap:8px; align-items:center; font-size:0.9rem; user-select:none; }
  </style>
</head>
<body>
<div class="container">
  <h1>売上一覧PDF → 会計ソフト用CSV（座標解析で取引先・税率別（税込）を抽出）</h1>

  <div class="upload-area">
    <p style="margin:0 0 10px; font-weight:800; color:#1565c0;">1) PDFファイルを選択</p>
    <input type="file" id="pdfInput" accept="application/pdf"/>
    <div class="row" style="margin-top:10px;">
      <div class="toggle">
        <input type="checkbox" id="dbgToggle"/>
        <label for="dbgToggle">デバッグログを表示</label>
      </div>
      <div class="hint">※（得意先）一覧のコードは除外し、取引先ブロック内の「10%/8%」行から税込を作ります。</div>
    </div>
    <p id="status"></p>
  </div>

  <div id="resultsArea" style="display:none;">
    <div class="setting-area">
      <label>仕訳日付:</label>
      <input type="date" id="targetDate"/>
      <span class="hint">※PDFの「期間（～）」から月末日を推定します（見つからない場合は当月末）。</span>
    </div>

    <table id="dataTable">
      <thead>
        <tr>
          <th style="width:28%;">取引先名</th>
          <th style="width:14%;">コード</th>
          <th style="width:18%;">10% 売上（税込）</th>
          <th style="width:18%;">8% 売上（税込）</th>
          <th style="width:18%;">入金額</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button type="button" class="btn btn-csv" onclick="downloadCSV()">会計ソフト用 CSVをダウンロード</button>
    <button type="button" class="btn btn-json" onclick="downloadDebugJSON()">抽出データ(JSON)をダウンロード（検証用）</button>

    <div id="debug"></div>
  </div>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

  const pdfInput = document.getElementById("pdfInput");
  const statusEl = document.getElementById("status");
  const resultsArea = document.getElementById("resultsArea");
  const tbody = document.querySelector("#dataTable tbody");
  const dateInput = document.getElementById("targetDate");
  const dbgToggle = document.getElementById("dbgToggle");
  const debugEl = document.getElementById("debug");

  const CODE_RE = /^\d{8}-\d{3}$/;

  let extractedData = [];
  let debugLog = [];
  let lastRawCustomers = [];

  dbgToggle.addEventListener("change", () => {
    debugEl.style.display = dbgToggle.checked ? "block" : "none";
    renderDebug();
  });

  function logDbg(msg) {
    debugLog.push(msg);
    renderDebug();
  }
  function renderDebug() {
    if (!dbgToggle.checked) return;
    debugEl.textContent = debugLog.join("\n");
  }

  function isAmountToken(s) {
    const t = (s || "").trim();
    // 整数（カンマあり/なし）、マイナス、括弧マイナスを許可
    return /^-?\(?\d{1,3}(,\d{3})*\)?$/.test(t) || /^-?\(?\d+\)?$/.test(t);
  }

  function isDecimalToken(s){
    const t=(s||"").trim();
    return /^\d+\.\d+$/.test(t);
  }

  function parseNum(s) {
    let t = (s || "").trim();
    if (!t) return 0;

    let neg = false;
    if (t.startsWith("(") && t.endsWith(")")) {
      neg = true;
      t = t.slice(1, -1);
    }
    t = t.replace(/,/g, "");
    if (t.startsWith("-")) {
      neg = true;
      t = t.slice(1);
    }
    const n = parseInt(t, 10);
    if (Number.isNaN(n)) return 0;
    return neg ? -n : n;
  }

  function csvEscape(v) {
    const s = String(v ?? "");
    if (/[",\r\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
    return s;
  }

  async function getPageLines(page) {
    const viewport = page.getViewport({ scale: 1.0 });
    const tc = await page.getTextContent();

    // item座標をviewport座標に変換（yは上→下に増える座標系）
    const items = tc.items
      .map(it => {
        const str = (it.str || "").trim();
        if (!str) return null;
        const tx = pdfjsLib.Util.transform(viewport.transform, it.transform);
        const x = tx[4];
        const y = tx[5];
        return { str, x, y };
      })
      .filter(Boolean);

    // yで行グルーピング（近いyを同一行として束ねる）
    const buckets = new Map();
    const tol = 2; // 行の許容誤差（pt）

    for (const it of items) {
      const yKey = Math.round(it.y / tol) * tol;
      if (!buckets.has(yKey)) buckets.set(yKey, []);
      buckets.get(yKey).push(it);
    }

    const lines = Array.from(buckets.entries())
      .sort((a, b) => a[0] - b[0])
      .map(([yKey, arr]) => {
        arr.sort((a, b) => a.x - b.x);
        const text = arr.map(a => a.str).join(" ");
        return { y: yKey, items: arr, text };
      });

    return lines;
  }

  function findAnchorX(lines, needle) {
    for (const ln of lines) {
      for (const it of ln.items) {
        if ((it.str || "").includes(needle)) return it.x;
      }
    }
    return null;
  }

  function extractNameFromLine(line) {
    if (!line) return "";
    const parts = [];
    for (const it of line.items) {
      if (it.x > 260) continue; // 左側（取引先名領域）だけを見る
      const s = (it.str || "").trim();
      if (!s) continue;
      if (isAmountToken(s) || isDecimalToken(s)) continue;
      if (s === "%" || s === "率" || s === "消費税") continue;
      if (s.includes("本支店コード")) continue;
      if (s.includes("（現金未収額）")) continue;
      if (s.includes("当残高")) continue;
      if (s.includes("取") || s.includes("引") || s.includes("先") || s.includes("名")) {
        // 見出し語が混ざる場合があるので、単体見出しは除外
        // （ただし実名に含まれるケースは極小なので割り切り）
        // 連続して出るときは落とす
        if (s === "取" || s === "引" || s === "先" || s === "名") continue;
      }
      parts.push(s);
    }
    return parts.join(" ").trim();
  }

  function extractColumnNumber(line, colX, range = 90) {
    if (!line || colX == null) return 0;
    const candidates = [];
    for (const it of line.items) {
      const s = (it.str || "").trim();
      if (!isAmountToken(s)) continue;
      if (it.x >= colX - 10 && it.x <= colX + range) {
        candidates.push({ dx: Math.abs(it.x - colX), v: parseNum(s) });
      }
    }
    if (!candidates.length) return 0;
    candidates.sort((a, b) => a.dx - b.dx);
    return candidates[0].v;
  }

  function detectRate(lineText) {
    const t = lineText || "";
    if (/(^|\s)10\s*%/.test(t)) return 10;
    if (/(^|\s)8\s*%/.test(t)) return 8;
    return null;
  }

  function extractTaxTotalsFromRateLine(line, baseX, taxX) {
    let base = null;
    let tax = null;

    for (const it of line.items) {
      const s = (it.str || "").trim();
      if (!isAmountToken(s)) continue;

      // 右端の「税抜合計」「消費税合計」列位置に寄せて拾う
      if (it.x >= (baseX - 10) && it.x < (taxX - 10)) {
        base = parseNum(s);
      } else if (it.x >= (taxX - 10)) {
        tax = parseNum(s);
      }
    }
    if (base == null || tax == null) return { base: 0, tax: 0, ok: false };
    return { base, tax, ok: true };
  }

  function guessMonthEndFromText(allText) {
    // 例: "2025年12月1日 ... ～ 2025年12月31日 ..."
    const re = /(\d{4})年(\d{1,2})月(\d{1,2})日[\s\S]*?～[\s\S]*?(\d{4})年(\d{1,2})月(\d{1,2})日/;
    const m = (allText || "").match(re);
    if (m) {
      const endY = parseInt(m[4], 10);
      const endM = parseInt(m[5], 10);
      const last = new Date(endY, endM, 0); // 月は1-basedでOK（0日指定で月末）
      return last;
    }
    // fallback: 当月末
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth() + 1, 0);
  }

  function fmtDate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${dd}`;
  }

  function renderTable() {
    tbody.innerHTML = "";
    extractedData.forEach((row, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="text-align:left;">${csvEscape(row.name)}</td>
        <td>${csvEscape(row.code)}</td>
        <td><input type="number" id="s10_${idx}" value="${row.sales10 || 0}"></td>
        <td><input type="number" id="s8_${idx}" value="${row.sales8 || 0}"></td>
        <td><input type="number" id="pay_${idx}" value="${row.payment || 0}"></td>
      `;
      tbody.appendChild(tr);
    });
  }

  pdfInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    statusEl.textContent = "PDFを解析中...（ページ数が多いと少し時間がかかります）";
    resultsArea.style.display = "none";
    extractedData = [];
    lastRawCustomers = [];
    debugLog = [];
    renderDebug();

    try {
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

      const customers = new Map();

      let firstPageAllText = "";

      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const lines = await getPageLines(page);

        if (p === 1) {
          firstPageAllText = lines.map(l => l.text).join("\n");
        }

        // ページ内アンカー推定（列位置）
        const payX  = findAnchorX(lines, "入金/支払");
        let baseX = findAnchorX(lines, "税抜合計");
        let taxX  = findAnchorX(lines, "消費税合計");
        if (baseX == null) baseX = 480;
        if (taxX  == null) taxX  = 530;

        logDbg(`--- page ${p}/${pdf.numPages} --- payX=${payX?.toFixed?.(1) ?? "null"} baseX=${baseX.toFixed(1)} taxX=${taxX.toFixed(1)}`);

        let inFootList = false;

        for (let i = 0; i < lines.length; i++) {
          const ln = lines[i];

          if (ln.text.includes("（得意先）")) inFootList = true;
          if (inFootList && ln.text.includes("取引先：[")) inFootList = false;

          // 左端のコード（取引先ブロック開始）を検出
          const codeItem = ln.items.find(it => CODE_RE.test(it.str) && it.x < 120);
          if (!codeItem) continue;
          if (inFootList) continue;               // 得意先一覧コードは除外
          if (ln.text.includes("取引先：[")) continue;

          const code = codeItem.str;

          // 直前数行から「名前行」「数値行」を探索（0取引などでズレるケース対策）
          let nameLine = null;
          let summaryLine = null;

          for (let back = 1; back <= 7; back++) {
            const k = i - back;
            if (k < 0) break;
            const cand = lines[k];

            if (cand.text.includes("非課税対象額") || cand.text.includes("外税対象額")) continue;

            const name = extractNameFromLine(cand);
            if (name) {
              nameLine = cand;
              break;
            }
            // 数値だけの行をsummary候補として保持
            if (!summaryLine && /\d/.test(cand.text)) summaryLine = cand;
          }

          const name = extractNameFromLine(nameLine) || "不明な取引先";
          const payment = extractColumnNumber(summaryLine || nameLine, payX);

          // レコード作成 or 追記（同一取引先が複数ページに跨る可能性を考慮）
          if (!customers.has(code)) {
            customers.set(code, { code, name, sales10: 0, sales8: 0, payment: 0 });
          }
          const rec = customers.get(code);
          if (rec.name === "不明な取引先" && name !== "不明な取引先") rec.name = name;
          rec.payment += payment;

          // このコード行の後ろを走査して 10%/8% の税込合計を拾う（次のコードまで）
          for (let j = i + 1; j < lines.length; j++) {
            const ln2 = lines[j];
            if (ln2.text.includes("（得意先）")) break;

            const nextCode = ln2.items.find(it => CODE_RE.test(it.str) && it.x < 120);
            if (nextCode) break;

            const rate = detectRate(ln2.text);
            if (!rate) continue;

            const totals = extractTaxTotalsFromRateLine(ln2, baseX, taxX);
            if (!totals.ok) continue;

            const gross = (totals.base + totals.tax);
            if (rate === 10) rec.sales10 += gross;
            if (rate === 8)  rec.sales8  += gross;
          }
        }
      }

      // 日付（期間の～から月末推定）
      const lastDay = guessMonthEndFromText(firstPageAllText);
      dateInput.value = fmtDate(lastDay);

      // Map → 配列
      extractedData = Array.from(customers.values())
        .sort((a, b) => a.code.localeCompare(b.code));

      lastRawCustomers = extractedData;

      logDbg(`\n抽出完了: 取引先=${extractedData.length}件`);
      if (!extractedData.length) {
        statusEl.textContent =
          "抽出件数が0です。PDFが画像化（スキャン）されているか、文字情報の配置が異なる可能性があります。デバッグログをONにして確認してください。";
        resultsArea.style.display = "block";
        renderTable();
        return;
      }

      statusEl.textContent = "";
      resultsArea.style.display = "block";
      renderTable();

    } catch (err) {
      console.error(err);
      statusEl.textContent = "エラー：PDF解析に失敗しました（テキスト抽出不可の形式の可能性があります）。";
    }
  });

  function downloadCSV() {
    const dateStr = dateInput.value;
    if (!dateStr) { alert("日付を指定してください"); return; }

    const header = [
      "種類","課税区分","税率","P/L部門","借方コード","借方科目","補助コード","B/S部門管理",
      "貸方コード","貸方科目","補助コード","B/S部門管理","取引先コード","取引先名","摘要","税込金額","日付"
    ];

    const rows = [header.map(csvEscape).join(",")];

    extractedData.forEach((row, idx) => {
      const s10 = parseInt(document.getElementById(`s10_${idx}`).value, 10) || 0;
      const s8  = parseInt(document.getElementById(`s8_${idx}`).value, 10)  || 0;
      const pay = parseInt(document.getElementById(`pay_${idx}`).value, 10) || 0;

      // 売上（10%）
      if (s10 > 0) {
        rows.push([
          "売上","1","10","","1122","売掛金","","","4111","売上高","","",
          row.code,row.name,"売上計上(10%)", String(s10), dateStr
        ].map(csvEscape).join(","));
      }
      // 売上（8%）
      if (s8 > 0) {
        rows.push([
          "売上","1","8","","1122","売掛金","","","4111","売上高","","",
          row.code,row.name,"売上計上(8%)", String(s8), dateStr
        ].map(csvEscape).join(","));
      }
      // 入金
      if (pay > 0) {
        rows.push([
          "入金","0","0","","1113","普通預金","","","1122","売掛金","","",
          row.code,row.name,"入金", String(pay), dateStr
        ].map(csvEscape).join(","));
      }
    });

    if (rows.length === 1) {
      alert("出力するデータがありません（全て0のため）。");
      return;
    }

    const csvString = "\uFEFF" + rows.join("\r\n");
    const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `売上仕訳データ_${dateStr}.csv`;
    link.click();
  }

  function downloadDebugJSON() {
    const blob = new Blob([JSON.stringify(lastRawCustomers, null, 2)], { type: "application/json;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `抽出結果_検証用.json`;
    link.click();
  }
</script>
</body>
</html>
