<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>㈲ケインズリカー｜売上一覧Excel → CSV変換（TKCコード対応）</title>

  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; background:#f4f6f8; color:#333; padding:20px; }
    .container { max-width: 1250px; margin:0 auto; background:#fff; padding:24px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
    h1 { color:#1565c0; font-size:1.35rem; text-align:center; border-bottom:2px solid #e3f2fd; padding-bottom:12px; margin:0 0 18px; }

    .upload-area { border:2px dashed #90caf9; background:#f3e5f5; padding:22px; text-align:center; border-radius:10px; margin-bottom:14px; }
    .upload-area input[type="file"] { font-size:1rem; cursor:pointer; }

    .setting-area { display:flex; gap:14px; background:#fff8e1; padding:12px; border-radius:10px; border:1px solid #ffe0b2; align-items:center; flex-wrap:wrap; margin-bottom:12px;}
    .setting-area label { font-weight:700; font-size:0.9rem; }
    .setting-area input[type="date"], .setting-area input[type="text"] {
      padding:8px; border-radius:6px; border:1px solid #ccc; font-size:0.95rem;
    }
    .hint { font-size:0.82rem; color:#666; }

    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #e0e0e0; padding:8px; text-align:center; font-size:0.9rem; }
    th { background:#f8f9fa; color:#444; }
    td { background:#fff; }

    td input.money, td input.code {
      width:92%; padding:6px;
      border:1px solid #cfd8dc; border-radius:6px;
      font-variant-numeric: tabular-nums;
      background:#ffffff;
    }
    td input.money { text-align:right; }
    td input.code { text-align:center; }

    .warn {
      outline: 2px solid rgba(211,47,47,0.35);
      background: rgba(255,235,238,0.7);
    }

    tfoot td { background:#eef7ff; font-weight:800; }
    .tfoot-label { text-align:right; color:#0d47a1; }
    .tfoot-num { text-align:right; font-variant-numeric: tabular-nums; }

    .btn { display:block; width:100%; padding:14px; border:none; border-radius:10px; font-size:1.05rem; font-weight:800; cursor:pointer; margin-top:12px; transition:0.15s; }
    .btn:hover { opacity:0.9; }
    .btn-csv { background:#2e7d32; color:#fff; }
    .btn-csv2 { background:#00695c; color:#fff; }
    .btn-json { background:#455a64; color:#fff; }

    #status { text-align:center; font-weight:700; color:#d32f2f; margin:10px 0 0; white-space:pre-wrap; }
    #debug { display:none; background:#0b1020; color:#e8eaf6; padding:12px; border-radius:10px; margin-top:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap; }
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .toggle { display:flex; gap:8px; align-items:center; font-size:0.9rem; user-select:none; }

    .pill { display:inline-block; padding:3px 8px; border-radius:999px; background:#e3f2fd; color:#0d47a1; font-size:0.78rem; font-weight:700; }

    .hidden { display:none !important; }
  </style>
</head>
<body>
<div class="container">
  <h1>㈲ケインズリカー｜売上一覧Excel → 会計ソフト用CSV（TKCコード・売上のみモード対応）</h1>

  <div class="upload-area">
    <p style="margin:0 0 10px; font-weight:800; color:#1565c0;">1) Excel（.xlsx）ファイルを選択</p>
    <input type="file" id="xlsxInput" accept=".xlsx,.xls" />
    <div class="row" style="margin-top:10px;">
      <div class="toggle">
        <input type="checkbox" id="dbgToggle"/>
        <label for="dbgToggle">デバッグログを表示</label>
      </div>
      <div class="hint">※Sheet1（末尾スペース含む “Sheet1 ”）のマスターから「取引先コード→TKCコード」を引当します。</div>
    </div>
    <p id="status"></p>
  </div>

  <div id="resultsArea" style="display:none;">
    <div class="setting-area">
      <label>仕訳日付:</label>
      <input type="date" id="targetDate"/>
      <span class="hint">※Excel内の「YYYY年M月」から月末日を推定（見つからない場合は当月末）。</span>
      <span class="pill" id="countPill">0件</span>
    </div>

    <div class="setting-area">
      <div class="toggle">
        <input type="checkbox" id="includePayment" checked />
        <label for="includePayment">入金行も出力する</label>
      </div>

      <div class="toggle">
        <input type="checkbox" id="useTkcForCsv" checked />
        <label for="useTkcForCsv">CSVの「取引先コード」にTKCコードを優先使用</label>
      </div>

      <label style="margin-left:6px;">入金列 見出し追加（任意）:</label>
      <input type="text" id="payHeaderExtra" placeholder="例：入金／支払額" style="min-width:220px;" />
      <button type="button" id="reparseBtn" style="padding:8px 10px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:700;">再抽出</button>

      <span class="hint">※入金が0ばかりの場合：ここに見出しを入力 →「再抽出」</span>
    </div>

    <table id="dataTable">
      <thead>
        <tr>
          <th style="width:26%;">取引先名</th>
          <th style="width:12%;">元コード</th>
          <th style="width:10%;">TKCコード</th>
          <th style="width:16%;">10% 売上（税込）</th>
          <th style="width:16%;">8% 売上（税込）</th>
          <th style="width:16%;" class="thPay">入金額（任意）</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td class="tfoot-label" colspan="3">合計</td>
          <td class="tfoot-num" id="sum10">0</td>
          <td class="tfoot-num" id="sum8">0</td>
          <td class="tfoot-num thPay" id="sumPay">0</td>
        </tr>
      </tfoot>
    </table>

    <button type="button" class="btn btn-csv" onclick="downloadCSV()">会計ソフト用 CSVをダウンロード（仕様固定）</button>
    <button type="button" class="btn btn-csv2" onclick="downloadAuditCSV()">確認用CSVをダウンロード（元コード＋TKCコード＋税率別）</button>
    <button type="button" class="btn btn-json" onclick="downloadDebugJSON()">抽出データ(JSON)をダウンロード（検証用）</button>

    <div id="debug"></div>
  </div>
</div>

<script>
  const xlsxInput = document.getElementById("xlsxInput");
  const statusEl = document.getElementById("status");
  const resultsArea = document.getElementById("resultsArea");
  const tbody = document.querySelector("#dataTable tbody");
  const dateInput = document.getElementById("targetDate");
  const dbgToggle = document.getElementById("dbgToggle");
  const debugEl = document.getElementById("debug");
  const countPill = document.getElementById("countPill");

  const includePaymentEl = document.getElementById("includePayment");
  const useTkcForCsvEl = document.getElementById("useTkcForCsv");
  const payHeaderExtraEl = document.getElementById("payHeaderExtra");
  const reparseBtn = document.getElementById("reparseBtn");

  const sum10El = document.getElementById("sum10");
  const sum8El  = document.getElementById("sum8");
  const sumPayEl= document.getElementById("sumPay");

  const CODE_RE = /^\d{8}-\d{3}$/;

  let extractedData = [];
  let debugLog = [];
  let lastRawCustomers = [];
  let lastArrayBuffer = null;
  let lastFileName = "";
  let masterMaps = { codeToTkc: new Map(), nameToTkc: new Map(), masterSheet: null };

  dbgToggle.addEventListener("change", () => {
    debugEl.style.display = dbgToggle.checked ? "block" : "none";
    renderDebug();
  });

  includePaymentEl.addEventListener("change", () => {
    applyPaymentVisibility();
    recomputeSums();
  });

  reparseBtn.addEventListener("click", async () => {
    if (!lastArrayBuffer) return;
    statusEl.textContent = "再抽出中...";
    extractedData = [];
    debugLog = [];
    renderDebug();
    resultsArea.style.display = "none";
    await parseWorkbook(lastArrayBuffer, lastFileName);
  });

  function logDbg(msg){ debugLog.push(msg); renderDebug(); }
  function renderDebug(){ if (!dbgToggle.checked) return; debugEl.textContent = debugLog.join("\n"); }

  // --- 集計ブロック判定（例：＝業務店掛計＝ / ＝合計＝） ---
  function isAggregateText(text){
    const s = String(text ?? "").replace(/\s+/g, "");
    return /＝.*(計|合計)＝/.test(s);
  }

  // ---- 表示金額（カンマ） ----
  function toComma(n){
    const num = Number(n);
    if (!Number.isFinite(num)) return "0";
    return Math.trunc(num).toLocaleString("ja-JP");
  }
  function stripComma(s){ return String(s ?? "").replace(/,/g, "").trim(); }
  function parseIntSafe(s){
    const t = stripComma(s);
    if (!t) return 0;
    const n = parseInt(t, 10);
    return Number.isFinite(n) ? n : 0;
  }

  function isAmountLike(v){
    if (typeof v === "number" && Number.isFinite(v)) return true;
    const s = String(v ?? "").trim();
    // (1,234) / -1,234 / 1234
    return /^-?\(?\d{1,3}(,\d{3})*\)?$/.test(s) || /^-?\(?\d+\)?$/.test(s);
  }
  function parseNum(v){
    if (typeof v === "number" && Number.isFinite(v)) return Math.trunc(v);
    let t = String(v ?? "").trim();
    if (!t) return 0;
    let neg = false;
    if (t.startsWith("(") && t.endsWith(")")) { neg = true; t = t.slice(1, -1); }
    t = t.replace(/,/g, "");
    if (t.startsWith("-")) { neg = true; t = t.slice(1); }
    const n = parseInt(t, 10);
    if (Number.isNaN(n)) return 0;
    return neg ? -n : n;
  }

  function csvEscape(v){
    const s = String(v ?? "");
    if (/[",\r\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
    return s;
  }

  // ---- 合計再計算 ----
  function recomputeSums(){
    let s10=0, s8=0, sp=0;
    for (let i=0;i<extractedData.length;i++){
      s10 += parseIntSafe(document.getElementById(`s10_${i}`).value);
      s8  += parseIntSafe(document.getElementById(`s8_${i}`).value);
      if (includePaymentEl.checked){
        sp  += parseIntSafe(document.getElementById(`pay_${i}`).value);
      }
    }
    sum10El.textContent = toComma(s10);
    sum8El.textContent  = toComma(s8);
    sumPayEl.textContent= toComma(sp);
  }

  function applyPaymentVisibility(){
    const show = includePaymentEl.checked;
    document.querySelectorAll(".thPay").forEach(el => {
      el.classList.toggle("hidden", !show);
    });
    // tbodyの入力はrenderTable時に作るので、ここでは列自体の見た目だけ
  }

  // ---- Excel 2D配列化（各シート）----
  function sheetToGrid(ws){
    return XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: true });
  }

  function rowText(row){
    return row.map(v => String(v ?? "").trim()).filter(Boolean).join(" ");
  }

  function detectRateFromRow(row){
    const t = rowText(row);
    if (/(^|\s)10\s*%/.test(t)) return 10;
    if (/(^|\s)8\s*%/.test(t)) return 8;
    return null;
  }

  // ★税率行：行内の“最後の2つの金額” = 税抜合計/消費税合計 とみなす（列ズレに強い）
  function extractBaseTaxFromRateRow(row){
    const nums = [];
    for (const v of row){
      if (isAmountLike(v)) nums.push(parseNum(v));
    }
    if (nums.length >= 2){
      const base = nums[nums.length - 2];
      const tax  = nums[nums.length - 1];
      return { base, tax, ok: true };
    }
    return { base: 0, tax: 0, ok: false };
  }

  // 取引先名の推定：同じ行のコード左側 or 直前数行から抽出
  function inferName(grid, r, codeCol){
    const sameRow = grid[r] || [];
    let parts = [];
    for (let c=0;c<codeCol;c++){
      const v = sameRow[c];
      const s = String(v ?? "").trim();
      if (!s) continue;
      if (isAggregateText(s)) continue;
      if (CODE_RE.test(s)) continue;
      if (isAmountLike(s)) continue;
      if (/(10\s*%|8\s*%)/.test(s)) continue;
      if (s.includes("（得意先）")) continue;
      parts.push(s);
    }
    const name1 = parts.join(" ").trim();
    if (name1 && !isAggregateText(name1)) return name1;

    for (let back=1; back<=7; back++){
      const rr = r - back;
      if (rr < 0) break;
      const row = grid[rr] || [];
      const t = rowText(row);
      if (!t) continue;
      if (isAggregateText(t)) continue;
      if (t.includes("非課税対象額") || t.includes("外税対象額") || t.includes("当残高")) continue;

      const cand = row
        .map(v => String(v ?? "").trim())
        .filter(s => s && !CODE_RE.test(s) && !isAmountLike(s) && !/(10\s*%|8\s*%)/.test(s))
        .join(" ")
        .trim();
      if (cand && !isAggregateText(cand)) return cand;
    }
    return "不明な取引先";
  }

  function normalizeName(s){
    return String(s ?? "")
      .replace(/\u3000/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  // ---- マスター（Sheet1）からTKCコード引当 ----
  function buildMasterMaps(wb){
    let masterSheetName = null;

    // 期待：シート名が "Sheet1 "（末尾スペースあり）等
    for (const name of wb.SheetNames){
      const ws = wb.Sheets[name];
      const grid = sheetToGrid(ws);
      const a1 = String((grid[0]||[])[0] ?? "").trim();
      const b1 = String((grid[0]||[])[1] ?? "").trim();
      const c1 = String((grid[0]||[])[2] ?? "").trim();
      if (a1 === "取引先名" && b1 === "取引先コード" && c1 === "TKCコード"){
        masterSheetName = name;
        break;
      }
    }

    const codeToTkc = new Map();
    const nameToTkc = new Map();

    if (!masterSheetName){
      logDbg("Master: 見つかりません（取引先名/取引先コード/TKCコード のヘッダシートなし）");
      return { codeToTkc, nameToTkc, masterSheet: null };
    }

    const ws = wb.Sheets[masterSheetName];
    const grid = sheetToGrid(ws);
    logDbg(`Master: "${masterSheetName}" rows=${grid.length}`);

    for (let r=1; r<grid.length; r++){
      const row = grid[r] || [];
      // 左ブロック A-C： 取引先名 / 取引先コード / TKCコード
      const nameL = normalizeName(row[0]);
      const codeL = row[1];
      const tkcL  = row[2];

      if (nameL && isAmountLike(codeL) && isAmountLike(tkcL)){
        const c = parseNum(codeL);
        const t = parseNum(tkcL);
        if (c > 0 && t > 0){
          codeToTkc.set(c, String(t));
          if (!nameToTkc.has(nameL)) nameToTkc.set(nameL, String(t));
        }
      }

      // 右ブロック E-F： 取引先名 / TKCコード（取引先コードなし）
      const nameR = normalizeName(row[4]);
      const tkcR  = row[5];
      if (nameR && isAmountLike(tkcR)){
        const t = parseNum(tkcR);
        if (t > 0 && !nameToTkc.has(nameR)) nameToTkc.set(nameR, String(t));
      }
    }

    logDbg(`Master maps: codeToTkc=${codeToTkc.size}, nameToTkc=${nameToTkc.size}`);
    return { codeToTkc, nameToTkc, masterSheet: masterSheetName };
  }

  function inferTkc(codeStr, name){
    // codeStr: "00003034-001"
    const head = String(codeStr ?? "").split("-")[0];
    const num = parseInt(head, 10);
    if (Number.isFinite(num) && masterMaps.codeToTkc.has(num)){
      return masterMaps.codeToTkc.get(num);
    }
    const n = normalizeName(name);
    if (n && masterMaps.nameToTkc.has(n)){
      return masterMaps.nameToTkc.get(n);
    }
    return "";
  }

  // ---- 入金列検出（見出し揺れ対応＋追加文字列）----
  function findPaymentCol(grid){
    const extra = normalizeName(payHeaderExtraEl.value);
    const candidates = [
      "入金/支払","入金／支払","入金/支払額","入金／支払額",
      "入金/支払金額","入金／支払金額","入金支払","入金 支払",
      "入金","支払","入金額","支払額","入金金額","支払金額"
    ];
    if (extra) candidates.unshift(extra);

    // ヘッダ行は上から3行くらいに出る前提（この帳票形式）
    const headerRows = [0,1,2].filter(i => i < grid.length);

    // 1st pass: 「入金」と「支払」の両方を含むセル（最優先）
    for (const r of headerRows){
      const row = grid[r] || [];
      for (let c=0; c<row.length; c++){
        const s = normalizeName(row[c]);
        if (!s) continue;
        if (s.includes("入金") && s.includes("支払")) return c;
      }
    }

    // 2nd pass: candidates に一致/包含
    for (const r of headerRows){
      const row = grid[r] || [];
      for (let c=0; c<row.length; c++){
        const s = normalizeName(row[c]);
        if (!s) continue;
        for (const cand of candidates){
          if (s === cand || s.includes(cand)) return c;
        }
      }
    }

    return null;
  }

  // 入金額：取引先コード周辺行の payCol セルから拾う（見つからなければ0）
  function extractPaymentAround(grid, r, payCol){
    if (payCol == null) return 0;

    // まず直前5行（この帳票は「名前行」に入金が載ることが多い）
    for (let rr=r; rr>=Math.max(0, r-5); rr--){
      const row = grid[rr] || [];
      const v = row[payCol];
      if (isAmountLike(v)) return parseNum(v);
    }
    // 次に直後2行
    for (let rr=r+1; rr<=Math.min(grid.length-1, r+2); rr++){
      const row = grid[rr] || [];
      const v = row[payCol];
      if (isAmountLike(v)) return parseNum(v);
    }
    return 0;
  }

  function guessMonthEndFromWorkbook(allTexts){
    const re = /(\d{4})年(\d{1,2})月/;
    const m = allTexts.match(re);
    if (m){
      const y = parseInt(m[1], 10);
      const mo = parseInt(m[2], 10);
      return new Date(y, mo, 0);
    }
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth()+1, 0);
  }
  function fmtDate(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  function renderTable(){
    tbody.innerHTML = "";
    const showPay = includePaymentEl.checked;

    extractedData.forEach((row, idx) => {
      const tr = document.createElement("tr");
      const tkcWarn = !row.tkc || row.tkc === "0";
      tr.innerHTML = `
        <td style="text-align:left;">${csvEscape(row.name)}</td>
        <td>${csvEscape(row.code)}</td>
        <td><input class="code ${tkcWarn ? "warn" : ""}" type="text" id="tkc_${idx}" value="${csvEscape(row.tkc || "")}" placeholder="未割当"></td>
        <td><input class="money" type="text" inputmode="numeric" id="s10_${idx}" value="${toComma(row.sales10 || 0)}"></td>
        <td><input class="money" type="text" inputmode="numeric" id="s8_${idx}" value="${toComma(row.sales8 || 0)}"></td>
        <td class="tdPay ${showPay ? "" : "hidden"}"><input class="money" type="text" inputmode="numeric" id="pay_${idx}" value="${toComma(row.payment || 0)}"></td>
      `;
      tbody.appendChild(tr);

      // money inputs
      ["s10_","s8_"].forEach(prefix => {
        const el = document.getElementById(`${prefix}${idx}`);
        el.addEventListener("focus", () => { el.value = stripComma(el.value); el.select?.(); });
        el.addEventListener("blur", () => { el.value = toComma(parseIntSafe(el.value)); recomputeSums(); });
        el.addEventListener("input", () => { el.value = el.value.replace(/[^\d,\-()]/g, ""); recomputeSums(); });
      });

      // tkc input
      const tkcEl = document.getElementById(`tkc_${idx}`);
      tkcEl.addEventListener("input", () => {
        tkcEl.value = tkcEl.value.replace(/[^\d]/g, "");
        tkcEl.classList.toggle("warn", !tkcEl.value);
      });

      // payment input (optional)
      if (showPay){
        const payEl = document.getElementById(`pay_${idx}`);
        payEl.addEventListener("focus", () => { payEl.value = stripComma(payEl.value); payEl.select?.(); });
        payEl.addEventListener("blur", () => { payEl.value = toComma(parseIntSafe(payEl.value)); recomputeSums(); });
        payEl.addEventListener("input", () => { payEl.value = payEl.value.replace(/[^\d,\-()]/g, ""); recomputeSums(); });
      }
    });

    countPill.textContent = `${extractedData.length}件`;
    applyPaymentVisibility();
    recomputeSums();
  }

  xlsxInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    statusEl.textContent = "Excelを解析中...（ローカルで処理します）";
    resultsArea.style.display = "none";
    extractedData = [];
    lastRawCustomers = [];
    debugLog = [];
    renderDebug();

    try {
      const buf = await file.arrayBuffer();
      lastArrayBuffer = buf;
      lastFileName = file.name;

      await parseWorkbook(buf, file.name);

    } catch (err){
      console.error(err);
      statusEl.textContent = "エラー：Excel解析に失敗しました（ファイル破損/形式差異の可能性）。";
    }
  });

  async function parseWorkbook(arrayBuffer, fileName){
    const wb = XLSX.read(arrayBuffer, { type: "array", cellDates: false });
    logDbg(`File: ${fileName}`);
    logDbg(`Sheets: ${wb.SheetNames.join(", ")}`);

    // マスター構築
    masterMaps = buildMasterMaps(wb);

    const customers = new Map();
    let allTexts = "";

    // 帳票シート：Masterシートは除外
    const reportSheets = wb.SheetNames.filter(n => n !== masterMaps.masterSheet);

    for (const sheetName of reportSheets){
      const ws = wb.Sheets[sheetName];
      const grid = sheetToGrid(ws);
      allTexts += "\n" + grid.map(r => rowText(r)).join("\n");

      const payCol = findPaymentCol(grid);
      logDbg(`--- sheet "${sheetName}" rows=${grid.length} payCol=${payCol ?? "null"} ---`);

      let inFootList = false;

      for (let r=0; r<grid.length; r++){
        const row = grid[r] || [];
        const t = rowText(row);

        if (t.includes("（得意先）")) inFootList = true;
        if (inFootList && t.includes("取引先：[")) inFootList = false;

        if (isAggregateText(t)) continue;

        // 取引先コード検出
        let code = null;
        let codeCol = -1;
        for (let c=0; c<row.length; c++){
          const s = String(row[c] ?? "").trim();
          if (CODE_RE.test(s)){
            code = s;
            codeCol = c;
            break;
          }
        }
        if (!code) continue;
        if (inFootList) continue;
        if (t.includes("取引先：[")) continue;

        const name = inferName(grid, r, codeCol);
        const tkc = inferTkc(code, name);

        // 入金（見つからなければ0）
        const payment = extractPaymentAround(grid, r, payCol);

        if (!customers.has(code)) customers.set(code, { code, name, tkc, sales10: 0, sales8: 0, payment: 0 });
        const rec = customers.get(code);

        // name/tkc の確定（不明→判明、空→判明）
        if (rec.name === "不明な取引先" && name !== "不明な取引先") rec.name = name;
        if (!rec.tkc && tkc) rec.tkc = tkc;

        // payment は二重加算を避け、より大きい絶対値を採用（0→値）
        if (payment !== 0 && Math.abs(payment) > Math.abs(rec.payment)) rec.payment = payment;

        // 税率行（10%/8%）を次の取引先コード or 集計ブロックまで拾う
        for (let rr=r; rr<Math.min(grid.length, r+80); rr++){
          const row2 = grid[rr] || [];
          const t2 = rowText(row2);
          if (!t2) continue;

          if (isAggregateText(t2)) break;

          // 次の取引先コードが来たら打ち切り（ただし同一行は除外）
          if (rr > r){
            let hasNextCode = false;
            for (let c=0;c<row2.length;c++){
              const s = String(row2[c] ?? "").trim();
              if (CODE_RE.test(s)) { hasNextCode = true; break; }
            }
            if (hasNextCode) break;
          }

          const rate = detectRateFromRow(row2);
          if (!rate) continue;

          const tot = extractBaseTaxFromRateRow(row2);
          if (!tot.ok) continue;

          const gross = tot.base + tot.tax;
          if (rate === 10) rec.sales10 += gross;
          if (rate === 8)  rec.sales8  += gross;
        }
      }
    }

    // 仕訳日付の推定（YYYY年M月を拾って月末）
    dateInput.value = fmtDate(guessMonthEndFromWorkbook(allTexts));

    extractedData = Array.from(customers.values())
      .filter(r => !isAggregateText(r.name))
      .sort((a,b) => a.code.localeCompare(b.code));

    lastRawCustomers = extractedData;

    if (!extractedData.length){
      statusEl.textContent = "抽出件数が0です。Excel形式（コード表記/シート構成）が想定と異なる可能性があります。デバッグログをONにして確認してください。";
      resultsArea.style.display = "block";
      renderTable();
      return;
    }

    statusEl.textContent = "";
    resultsArea.style.display = "block";
    renderTable();
  }

  function getCsvCustomerCode(idx, row){
    const tkc = document.getElementById(`tkc_${idx}`)?.value?.trim() ?? "";
    if (useTkcForCsvEl.checked && tkc) return tkc;
    // TKCを使わない or 空の場合は元コード
    return row.code;
  }

  function downloadCSV(){
    const dateStr = dateInput.value;
    if (!dateStr) { alert("日付を指定してください"); return; }

    // 会計ソフト用：列仕様は固定（追加列なし）
    const header = [
      "種類","課税区分","税率","P/L部門","借方コード","借方科目","補助コード","B/S部門管理",
      "貸方コード","貸方科目","補助コード","B/S部門管理","取引先コード","取引先名","摘要","税込金額","日付"
    ];
    const rows = [header.map(csvEscape).join(",")];

    extractedData.forEach((row, idx) => {
      const s10 = parseIntSafe(document.getElementById(`s10_${idx}`).value);
      const s8  = parseIntSafe(document.getElementById(`s8_${idx}`).value);
      const pay = includePaymentEl.checked ? parseIntSafe(document.getElementById(`pay_${idx}`)?.value) : 0;

      const custCode = getCsvCustomerCode(idx, row);
      const custName = row.name;

      if (s10 > 0){
        rows.push([
          "売上","1","10","","1122","売掛金","","","4111","売上高","","",
          custCode,custName,"売上計上(10%)", String(s10), dateStr
        ].map(csvEscape).join(","));
      }
      if (s8 > 0){
        rows.push([
          "売上","1","8","","1122","売掛金","","","4111","売上高","","",
          custCode,custName,"売上計上(8%)", String(s8), dateStr
        ].map(csvEscape).join(","));
      }
      if (includePaymentEl.checked && pay !== 0){
        rows.push([
          "入金","0","0","","1113","普通預金","","","1122","売掛金","","",
          custCode,custName,"入金", String(pay), dateStr
        ].map(csvEscape).join(","));
      }
    });

    if (rows.length === 1){
      alert("出力するデータがありません（全て0のため）。");
      return;
    }

    const csvString = "\uFEFF" + rows.join("\r\n");
    const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `売上仕訳データ_${dateStr}.csv`;
    link.click();
  }

  function downloadAuditCSV(){
    const dateStr = dateInput.value || "日付未設定";
    const header = ["元コード","TKCコード","取引先名","10%税込","8%税込","入金額"];
    const rows = [header.map(csvEscape).join(",")];

    extractedData.forEach((row, idx) => {
      const tkc = document.getElementById(`tkc_${idx}`)?.value?.trim() ?? "";
      const s10 = parseIntSafe(document.getElementById(`s10_${idx}`).value);
      const s8  = parseIntSafe(document.getElementById(`s8_${idx}`).value);
      const pay = includePaymentEl.checked ? parseIntSafe(document.getElementById(`pay_${idx}`)?.value) : 0;

      rows.push([
        row.code,
        tkc,
        row.name,
        String(s10),
        String(s8),
        String(pay)
      ].map(csvEscape).join(","));
    });

    const csvString = "\uFEFF" + rows.join("\r\n");
    const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `確認用_売上一覧_${dateStr}.csv`;
    link.click();
  }

  function downloadDebugJSON(){
    const blob = new Blob([JSON.stringify(lastRawCustomers, null, 2)], { type: "application/json;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `抽出結果_検証用.json`;
    link.click();
  }
</script>
</body>
</html>
