<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>㈲ケインズリカー｜売上一覧PDF → CSV変換ツール（集計行除外・税率別対応）</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; background:#f4f6f8; color:#333; padding:20px; }
    .container { max-width: 1100px; margin:0 auto; background:#fff; padding:24px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
    h1 { color:#1565c0; font-size:1.35rem; text-align:center; border-bottom:2px solid #e3f2fd; padding-bottom:12px; margin:0 0 18px; }

    .upload-area { border:2px dashed #90caf9; background:#f3e5f5; padding:22px; text-align:center; border-radius:10px; margin-bottom:14px; }
    .upload-area input[type="file"] { font-size:1rem; cursor:pointer; }

    .setting-area { display:flex; gap:14px; background:#fff8e1; padding:12px; border-radius:10px; border:1px solid #ffe0b2; align-items:center; flex-wrap:wrap; }
    .setting-area label { font-weight:700; font-size:0.9rem; }
    .setting-area input[type="date"] { padding:8px; border-radius:6px; border:1px solid #ccc; font-size:1rem; }
    .hint { font-size:0.82rem; color:#666; }

    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border:1px solid #e0e0e0; padding:8px; text-align:center; font-size:0.9rem; }
    th { background:#f8f9fa; color:#444; }
    td { background:#fff; }

    td input.money{
      width:92%; padding:6px; text-align:right;
      border:1px solid #cfd8dc; border-radius:6px;
      font-variant-numeric: tabular-nums;
      background:#ffffff;
    }

    tfoot td { background:#eef7ff; font-weight:800; }
    .tfoot-label { text-align:right; color:#0d47a1; }
    .tfoot-num { text-align:right; font-variant-numeric: tabular-nums; }

    .btn { display:block; width:100%; padding:14px; border:none; border-radius:10px; font-size:1.08rem; font-weight:800; cursor:pointer; margin-top:14px; transition:0.15s; }
    .btn:hover { opacity:0.9; }
    .btn-csv { background:#2e7d32; color:#fff; }
    .btn-json { background:#455a64; color:#fff; }

    #status { text-align:center; font-weight:700; color:#d32f2f; margin:10px 0 0; white-space:pre-wrap; }
    #debug { display:none; background:#0b1020; color:#e8eaf6; padding:12px; border-radius:10px; margin-top:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap; }
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .toggle { display:flex; gap:8px; align-items:center; font-size:0.9rem; user-select:none; }
  </style>
</head>
<body>
<div class="container">
  <h1>㈲ケインズリカー｜売上一覧PDF → 会計ソフト用CSV（集計行を無視して税率別（税込）を抽出）</h1>

  <div class="upload-area">
    <p style="margin:0 0 10px; font-weight:800; color:#1565c0;">1) PDFファイルを選択</p>
    <input type="file" id="pdfInput" accept="application/pdf"/>
    <div class="row" style="margin-top:10px;">
      <div class="toggle">
        <input type="checkbox" id="dbgToggle"/>
        <label for="dbgToggle">デバッグログを表示</label>
      </div>
      <div class="hint">※「＝業務店掛計＝」等の集計ブロックは自動で無視します。</div>
    </div>
    <p id="status"></p>
  </div>

  <div id="resultsArea" style="display:none;">
    <div class="setting-area">
      <label>仕訳日付:</label>
      <input type="date" id="targetDate"/>
      <span class="hint">※PDFの期間（～）から月末日を推定（見つからない場合は当月末）。</span>
    </div>

    <table id="dataTable">
      <thead>
        <tr>
          <th style="width:28%;">取引先名</th>
          <th style="width:14%;">コード</th>
          <th style="width:18%;">10% 売上（税込）</th>
          <th style="width:18%;">8% 売上（税込）</th>
          <th style="width:18%;">入金額</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td class="tfoot-label" colspan="2">合計</td>
          <td class="tfoot-num" id="sum10">0</td>
          <td class="tfoot-num" id="sum8">0</td>
          <td class="tfoot-num" id="sumPay">0</td>
        </tr>
      </tfoot>
    </table>

    <button type="button" class="btn btn-csv" onclick="downloadCSV()">会計ソフト用 CSVをダウンロード</button>
    <button type="button" class="btn btn-json" onclick="downloadDebugJSON()">抽出データ(JSON)をダウンロード（検証用）</button>

    <div id="debug"></div>
  </div>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

  const pdfInput = document.getElementById("pdfInput");
  const statusEl = document.getElementById("status");
  const resultsArea = document.getElementById("resultsArea");
  const tbody = document.querySelector("#dataTable tbody");
  const dateInput = document.getElementById("targetDate");
  const dbgToggle = document.getElementById("dbgToggle");
  const debugEl = document.getElementById("debug");

  const sum10El = document.getElementById("sum10");
  const sum8El  = document.getElementById("sum8");
  const sumPayEl= document.getElementById("sumPay");

  const CODE_RE = /^\d{8}-\d{3}$/;

  let extractedData = [];
  let debugLog = [];
  let lastRawCustomers = [];

  dbgToggle.addEventListener("change", () => {
    debugEl.style.display = dbgToggle.checked ? "block" : "none";
    renderDebug();
  });

  function logDbg(msg) { debugLog.push(msg); renderDebug(); }
  function renderDebug() { if (!dbgToggle.checked) return; debugEl.textContent = debugLog.join("\n"); }

  // --- 重要：集計ブロック判定（＝…計＝ / ＝…合計＝） ---
  function isAggregateLineText(text){
    const s = String(text ?? "").replace(/\s+/g, "");
    return /＝.*(計|合計)＝/.test(s);
  }

  // ---- 金額表示（カンマ） ----
  function toComma(n) {
    const num = Number(n);
    if (!Number.isFinite(num)) return "0";
    return Math.trunc(num).toLocaleString("ja-JP");
  }
  function stripComma(s) {
    return String(s ?? "").replace(/,/g, "").trim();
  }
  function parseIntSafe(s) {
    const t = stripComma(s);
    if (!t) return 0;
    const n = parseInt(t, 10);
    return Number.isFinite(n) ? n : 0;
  }

  // ---- 合計再計算 ----
  function recomputeSums() {
    let s10 = 0, s8 = 0, sp = 0;
    for (let i = 0; i < extractedData.length; i++) {
      s10 += parseIntSafe(document.getElementById(`s10_${i}`).value);
      s8  += parseIntSafe(document.getElementById(`s8_${i}`).value);
      sp  += parseIntSafe(document.getElementById(`pay_${i}`).value);
    }
    sum10El.textContent = toComma(s10);
    sum8El.textContent  = toComma(s8);
    sumPayEl.textContent= toComma(sp);
  }

  function isAmountToken(s) {
    const t = (s || "").trim();
    return /^-?\(?\d{1,3}(,\d{3})*\)?$/.test(t) || /^-?\(?\d+\)?$/.test(t);
  }
  function isDecimalToken(s){ const t=(s||"").trim(); return /^\d+\.\d+$/.test(t); }

  function parseNum(s) {
    let t = (s || "").trim();
    if (!t) return 0;
    let neg = false;
    if (t.startsWith("(") && t.endsWith(")")) { neg = true; t = t.slice(1, -1); }
    t = t.replace(/,/g, "");
    if (t.startsWith("-")) { neg = true; t = t.slice(1); }
    const n = parseInt(t, 10);
    if (Number.isNaN(n)) return 0;
    return neg ? -n : n;
  }

  function csvEscape(v) {
    const s = String(v ?? "");
    if (/[",\r\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
    return s;
  }

  async function getPageLines(page) {
    const viewport = page.getViewport({ scale: 1.0 });
    const tc = await page.getTextContent();

    const items = tc.items
      .map(it => {
        const str = (it.str || "").trim();
        if (!str) return null;
        const tx = pdfjsLib.Util.transform(viewport.transform, it.transform);
        const x = tx[4];
        const y = tx[5];
        return { str, x, y };
      })
      .filter(Boolean);

    const buckets = new Map();
    const tol = 2;

    for (const it of items) {
      const yKey = Math.round(it.y / tol) * tol;
      if (!buckets.has(yKey)) buckets.set(yKey, []);
      buckets.get(yKey).push(it);
    }

    const lines = Array.from(buckets.entries())
      .sort((a, b) => a[0] - b[0])
      .map(([yKey, arr]) => {
        arr.sort((a, b) => a.x - b.x);
        const text = arr.map(a => a.str).join(" ");
        return { y: yKey, items: arr, text };
      });

    return lines;
  }

  function findAnchorX(lines, needle) {
    for (const ln of lines) {
      for (const it of ln.items) {
        if ((it.str || "").includes(needle)) return it.x;
      }
    }
    return null;
  }

  function extractNameFromLine(line) {
    if (!line) return "";
    const parts = [];
    for (const it of line.items) {
      if (it.x > 260) continue;
      const s = (it.str || "").trim();
      if (!s) continue;
      if (isAmountToken(s) || isDecimalToken(s)) continue;
      if (s === "%" || s === "率" || s === "消費税") continue;
      if (s.includes("本支店コード")) continue;
      if (s.includes("（現金未収額）")) continue;
      if (s.includes("当残高")) continue;
      if (s === "取" || s === "引" || s === "先" || s === "名") continue;
      parts.push(s);
    }
    const name = parts.join(" ").trim();
    if (isAggregateLineText(name)) return ""; // 保険：集計ラベルは取引先名にしない
    return name;
  }

  function extractColumnNumber(line, colX, range = 90) {
    if (!line || colX == null) return 0;
    const candidates = [];
    for (const it of line.items) {
      const s = (it.str || "").trim();
      if (!isAmountToken(s)) continue;
      if (it.x >= colX - 10 && it.x <= colX + range) {
        candidates.push({ dx: Math.abs(it.x - colX), v: parseNum(s) });
      }
    }
    if (!candidates.length) return 0;
    candidates.sort((a, b) => a.dx - b.dx);
    return candidates[0].v;
  }

  function detectRate(lineText) {
    const t = lineText || "";
    if (/(^|\s)10\s*%/.test(t)) return 10;
    if (/(^|\s)8\s*%/.test(t)) return 8;
    return null;
  }

  // ★ 修正：税率行は「行内の最後の2つの金額」を 税抜合計・消費税合計 とみなす（列ズレ耐性）
  function extractTaxTotalsFromRateLine(line) {
    const nums = line.items
      .map(it => ({ x: it.x, s: (it.str || "").trim() }))
      .filter(o => isAmountToken(o.s))
      .sort((a,b) => a.x - b.x)
      .map(o => parseNum(o.s));

    if (nums.length >= 2) {
      const base = nums[nums.length - 2];
      const tax  = nums[nums.length - 1];
      return { base, tax, ok: true };
    }
    return { base: 0, tax: 0, ok: false };
  }

  function guessMonthEndFromText(allText) {
    const re = /(\d{4})年(\d{1,2})月(\d{1,2})日[\s\S]*?～[\s\S]*?(\d{4})年(\d{1,2})月(\d{1,2})日/;
    const m = (allText || "").match(re);
    if (m) {
      const endY = parseInt(m[4], 10);
      const endM = parseInt(m[5], 10);
      return new Date(endY, endM, 0);
    }
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth() + 1, 0);
  }
  function fmtDate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${dd}`;
  }

  function renderTable() {
    tbody.innerHTML = "";
    extractedData.forEach((row, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="text-align:left;">${csvEscape(row.name)}</td>
        <td>${csvEscape(row.code)}</td>
        <td><input class="money" type="text" inputmode="numeric" id="s10_${idx}" value="${toComma(row.sales10 || 0)}"></td>
        <td><input class="money" type="text" inputmode="numeric" id="s8_${idx}" value="${toComma(row.sales8 || 0)}"></td>
        <td><input class="money" type="text" inputmode="numeric" id="pay_${idx}" value="${toComma(row.payment || 0)}"></td>
      `;
      tbody.appendChild(tr);

      ["s10_", "s8_", "pay_"].forEach(prefix => {
        const el = document.getElementById(`${prefix}${idx}`);

        el.addEventListener("focus", () => {
          el.value = stripComma(el.value);
          el.select?.();
        });

        el.addEventListener("blur", () => {
          el.value = toComma(parseIntSafe(el.value));
          recomputeSums();
        });

        el.addEventListener("input", () => {
          el.value = el.value.replace(/[^\d,\-()]/g, "");
          recomputeSums();
        });
      });
    });

    recomputeSums();
  }

  pdfInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    statusEl.textContent = "PDFを解析中...（ページ数が多いと少し時間がかかります）";
    resultsArea.style.display = "none";
    extractedData = [];
    lastRawCustomers = [];
    debugLog = [];
    renderDebug();

    try {
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

      const customers = new Map();
      let firstPageAllText = "";

      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const lines = await getPageLines(page);

        if (p === 1) firstPageAllText = lines.map(l => l.text).join("\n");

        const payX  = findAnchorX(lines, "入金/支払");
        logDbg(`--- page ${p}/${pdf.numPages} --- payX=${payX?.toFixed?.(1) ?? "null"}`);

        let inFootList = false;

        for (let i = 0; i < lines.length; i++) {
          const ln = lines[i];

          if (ln.text.includes("（得意先）")) inFootList = true;
          if (inFootList && ln.text.includes("取引先：[")) inFootList = false;

          const codeItem = ln.items.find(it => CODE_RE.test(it.str) && it.x < 160);
          if (!codeItem) continue;
          if (inFootList) continue;
          if (ln.text.includes("取引先：[")) continue;

          const code = codeItem.str;

          // 取引先名の推測（コード行の直前付近）
          let nameLine = null;
          let summaryLine = null;

          for (let back = 1; back <= 7; back++) {
            const k = i - back;
            if (k < 0) break;
            const cand = lines[k];

            if (isAggregateLineText(cand.text)) continue; // ★重要：集計行は参照しない
            if (cand.text.includes("非課税対象額") || cand.text.includes("外税対象額")) continue;

            const name = extractNameFromLine(cand);
            if (name) { nameLine = cand; break; }
            if (!summaryLine && /\d/.test(cand.text)) summaryLine = cand;
          }

          const name = extractNameFromLine(nameLine) || "不明な取引先";
          const payment = extractColumnNumber(summaryLine || nameLine, payX);

          if (!customers.has(code)) customers.set(code, { code, name, sales10: 0, sales8: 0, payment: 0 });
          const rec = customers.get(code);
          if (rec.name === "不明な取引先" && name !== "不明な取引先") rec.name = name;
          rec.payment += payment;

          // ★重要：この取引先の税率行を拾う（集計行に当たったら打ち切り）
          for (let j = i + 1; j < lines.length; j++) {
            const ln2 = lines[j];

            if (ln2.text.includes("（得意先）")) break;

            // 集計ブロックに入ったら終了（＝業務店掛計＝ 等）
            if (isAggregateLineText(ln2.text)) {
              logDbg(`STOP（集計検出）: code=${code} name=${rec.name} line="${ln2.text}"`);
              break;
            }

            // 次の取引先コードが来たら終了
            const nextCode = ln2.items.find(it => CODE_RE.test(it.str) && it.x < 160);
            if (nextCode) break;

            const rate = detectRate(ln2.text);
            if (!rate) continue;

            const totals = extractTaxTotalsFromRateLine(ln2);
            if (!totals.ok) continue;

            const gross = totals.base + totals.tax;
            if (rate === 10) rec.sales10 += gross;
            if (rate === 8)  rec.sales8  += gross;
          }
        }
      }

      const lastDay = guessMonthEndFromText(firstPageAllText);
      dateInput.value = fmtDate(lastDay);

      extractedData = Array.from(customers.values()).sort((a, b) => a.code.localeCompare(b.code));
      lastRawCustomers = extractedData;

      logDbg(`\n抽出完了: 取引先=${extractedData.length}件`);
      if (!extractedData.length) {
        statusEl.textContent =
          "抽出件数が0です。PDFが画像化（スキャン）されているか、文字情報の配置が異なる可能性があります。デバッグログをONにして確認してください。";
        resultsArea.style.display = "block";
        renderTable();
        return;
      }

      statusEl.textContent = "";
      resultsArea.style.display = "block";
      renderTable();

    } catch (err) {
      console.error(err);
      statusEl.textContent = "エラー：PDF解析に失敗しました（テキスト抽出不可の形式の可能性があります）。";
    }
  });

  function downloadCSV() {
    const dateStr = dateInput.value;
    if (!dateStr) { alert("日付を指定してください"); return; }

    const header = [
      "種類","課税区分","税率","P/L部門","借方コード","借方科目","補助コード","B/S部門管理",
      "貸方コード","貸方科目","補助コード","B/S部門管理","取引先コード","取引先名","摘要","税込金額","日付"
    ];

    const rows = [header.map(csvEscape).join(",")];

    extractedData.forEach((row, idx) => {
      const s10 = parseIntSafe(document.getElementById(`s10_${idx}`).value);
      const s8  = parseIntSafe(document.getElementById(`s8_${idx}`).value);
      const pay = parseIntSafe(document.getElementById(`pay_${idx}`).value);

      if (s10 > 0) {
        rows.push([
          "売上","1","10","","1122","売掛金","","","4111","売上高","","",
          row.code,row.name,"売上計上(10%)", String(s10), dateStr
        ].map(csvEscape).join(","));
      }
      if (s8 > 0) {
        rows.push([
          "売上","1","8","","1122","売掛金","","","4111","売上高","","",
          row.code,row.name,"売上計上(8%)", String(s8), dateStr
        ].map(csvEscape).join(","));
      }
      if (pay > 0) {
        rows.push([
          "入金","0","0","","1113","普通預金","","","1122","売掛金","","",
          row.code,row.name,"入金", String(pay), dateStr
        ].map(csvEscape).join(","));
      }
    });

    if (rows.length === 1) { alert("出力するデータがありません（全て0のため）。"); return; }

    const csvString = "\uFEFF" + rows.join("\r\n");
    const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `売上仕訳データ_${dateStr}.csv`;
    link.click();
  }

  function downloadDebugJSON() {
    const blob = new Blob([JSON.stringify(lastRawCustomers, null, 2)], { type: "application/json;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `抽出結果_検証用.json`;
    link.click();
  }
</script>
</body>
</html>
